<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>보험 계약 관리</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background: #f4f4f4;
            font-family: Arial, sans-serif;
        }

        .container {
            width: 800px;
            background: white;
            padding: 25px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        label {
            font-weight: bold;
        }

        input, select {
            width: 100%;
            padding: 6px;
            margin: 5px 0 15px;
            border: 1px solid #bbb;
            border-radius: 4px;
        }

        button {
            padding: 8px 12px;
            margin-top: 5px;
            border: none;
            background: #4b89dc;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #3a6fb3;
        }

        #contract-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #contract-table th, #contract-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }

        #contract-table th {
            background: #e8e8e8;
        }

        hr {
            margin: 25px 0;
        }
    </style>
</head>

<body>

<div class="container">

    <h2>보험 계약 관리</h2>

    <label>고객명:</label>
    <select id="customerSelect" onchange="loadCustomerInfo()"></select>

    <label>고객코드</label>
    <input id="code" readonly>

    <label>생년월일</label>
    <input id="birth" readonly>

    <label>연락처</label>
    <input id="tel" readonly>

    <hr>

    <label>보험상품:</label>
    <select id="productSelect"></select>

    <label>가입금액:</label>
    <input type="number" id="regPrice">

    <label>월 보험료:</label>
    <input type="number" id="monthPrice">

    <label>담당자:</label>
    <select id="adminSelect"></select>

    <button onclick="addContract()">가입</button>

    <hr>

    <h3>고객 보험 계약현황</h3>

    <table id="contract-table">
        <thead>
        <tr>
            <th>상품명</th>
            <th>가입금액</th>
            <th>월보험료</th>
            <th>담당자</th>
            <th>가입일</th>
            <th>삭제</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

</div>

<script>
    let currentCustomerCode = "";

    document.addEventListener("DOMContentLoaded", () => {
        loadCustomers();
        loadProducts();
        loadAdmins();
    });

    function loadCustomers() {
        fetch("/contract/customers")
            .then(res => res.json())
            .then(list => {
                const select = document.getElementById("customerSelect");
                select.innerHTML = "";
                list.forEach(name => {
                    select.innerHTML += `<option>${name}</option>`;
                });
                loadCustomerInfo();
            });
    }

    function loadCustomerInfo() {
        const name = document.getElementById("customerSelect").value;

        fetch("/contract/customerInfo?name=" + name)
            .then(res => res.json())
            .then(c => {
                document.getElementById("code").value = c.code;
                document.getElementById("birth").value = c.birth;
                document.getElementById("tel").value = c.tel;

                currentCustomerCode = c.code;
                loadContractList();
            });
    }

    function loadProducts() {
        fetch("/contract/products")
            .then(res => res.json())
            .then(list => {
                const select = document.getElementById("productSelect");
                select.innerHTML = "";
                list.forEach(p => {
                    select.innerHTML += `<option>${p}</option>`;
                });
            });
    }

    function loadAdmins() {
        fetch("/contract/admins")
            .then(res => res.json())
            .then(list => {
                const select = document.getElementById("adminSelect");
                select.innerHTML = "";
                list.forEach(a => {
                    select.innerHTML += `<option>${a}</option>`;
                });
            });
    }

    function loadContractList() {
        fetch("/contract/list?customerCode=" + currentCustomerCode)
            .then(res => res.json())
            .then(list => {
                const tbody = document.querySelector("#contract-table tbody");
                tbody.innerHTML = "";

                list.forEach(c => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${c.contractName}</td>
                            <td>${c.regPrice}</td>
                            <td>${c.monthPrice}</td>
                            <td>${c.adminName}</td>
                            <td>${c.regDate}</td>
                            <td><button onclick='deleteContract(${JSON.stringify(c)})'>삭제</button></td>
                        </tr>
                    `;
                });
            });
    }

    function addContract() {
        const contract = {
            customerCode: currentCustomerCode,
            contractName: document.getElementById("productSelect").value,
            regPrice: document.getElementById("regPrice").value,
            monthPrice: document.getElementById("monthPrice").value,
            adminName: document.getElementById("adminSelect").value
        };

        fetch("/contract/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(contract)
        })
            .then(res => res.json())
            .then(success => {
                if (success) {
                    alert("가입 완료!");
                    loadContractList();
                } else {
                    alert("가입 실패");
                }
            });
    }

    function deleteContract(c) {
        if (!confirm("삭제하시겠습니까?")) return;

        const params = new URLSearchParams();
        params.append("customerCode", c.customerCode);
        params.append("contractName", c.contractName);
        params.append("regDate", c.regDate.substring(0, 10));

        fetch("/contract/delete?" + params.toString(), {
            method: "DELETE"
        })
            .then(res => res.json())
            .then(success => {
                if (success) {
                    alert("삭제되었습니다.");
                    loadContractList();
                } else {
                    alert("삭제 실패");
                }
            });
    }
</script>

</body>
</html>
